<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zombie Chemistry Shooter + AI</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&amp;family=Kanit:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    @keyframes zombieIdle {
      0%, 100% { transform: translateX(0) translateY(0) rotate(-1deg); }
      50% { transform: translateX(0) translateY(5px) rotate(1deg); }
    }
    @keyframes zombieHover {
      0%, 100% { transform: scale(1.05) translateY(-5px); filter: brightness(1.2) drop-shadow(0 0 10px rgba(255, 0, 0, 0.5)); }
      50% { transform: scale(1.05) translateY(-2px); filter: brightness(1.2) drop-shadow(0 0 15px rgba(255, 0, 0, 0.8)); }
    }
    @keyframes zombieArm {
      0%, 100% { transform: rotateZ(-20deg); }
      50% { transform: rotateZ(20deg); }
    }
    @keyframes gunsightAim {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes crosshairPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes scorePopup {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
    }
    @keyframes fogFloat {
      0%, 100% { transform: translateX(0); opacity: 0.3; }
      50% { transform: translateX(20px); opacity: 0.2; }
    }

    .zombie-idle { animation: zombieIdle 3s ease-in-out infinite; }
    .zombie-hover { animation: zombieHover 1s ease-in-out infinite; }
    .zombie-arm { animation: zombieArm 1.5s ease-in-out infinite; }
    .gunsight-aim { animation: gunsightAim 0.5s ease-out; }
    .crosshair-pulse { animation: crosshairPulse 1.5s ease-in-out infinite; }
    .score-popup { animation: scorePopup 1.5s ease-out forwards; position: absolute; pointer-events: none; font-weight: bold; font-size: 4rem; z-index: 9999; text-shadow: 3px 3px 0 #000; font-family: 'Creepster', cursive; }
    .fog-float { animation: fogFloat 6s ease-in-out infinite; }
    
    .game-font { font-family: 'Creepster', cursive; }
    .thai-font { font-family: 'Kanit', sans-serif; }
    .choice-btn { transition: all 0.2s ease; }
    .choice-btn:hover:not(:disabled) { transform: translateX(8px); filter: brightness(1.2); }
    .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); transform: none; }
    
    html, body, #app { height: 100%; width: 100%; }
    body { box-sizing: border-box; margin: 0; }
    
    /* Night gradient */
    .night-bg {
      background: linear-gradient(180deg, #0a0a15 0%, #1a0a2e 40%, #0f051a 100%);
      position: relative;
    }
    
    .night-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(circle at 80% 10%, rgba(255,200,100,0.05) 0%, transparent 40%),
        radial-gradient(circle at 20% 80%, rgba(100,150,255,0.03) 0%, transparent 40%);
      pointer-events: none;
    }

    /* Loader */
    .loader {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #4ade80;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Perspective Scene */
    .scene-container {
      perspective: 1000px;
      overflow: hidden;
      position: relative;
    }
    
    .ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50%;
      background: linear-gradient(to top, #0f051a 0%, #1a0a2e 100%);
      opacity: 0.9;
      z-index: 1;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="thai-font" style="margin: 0; overflow: hidden;">
  <div id="app" class="h-full w-full overflow-auto"></div>
  <script>
    const defaultConfig = {
      game_title: "üßü ‡∏¢‡∏¥‡∏á‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ‡πÄ‡∏Ñ‡∏°‡∏µ üî´",
      start_button_text: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡πà‡∏≤‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ!",
      time_limit: "30",
      background_color: "#1a1a2e",
      surface_color: "#16213e",
      text_color: "#e94560",
      primary_action: "#4ade80",
      secondary_action: "#fbbf24"
    };

    let config = { ...defaultConfig };
    let gameState = {
      currentScreen: 'start',
      zombiesKilled: 0,
      score: 0,
      currentQuestion: null,
      zombies: [],
      answeredZombies: new Set(),
      timeLeft: 30,
      timerActive: false,
      mouseX: 0,
      mouseY: 0,
      timerInterval: null,
      isAiLoading: false,
      aiHintText: ""
    };

    // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    const initialQuestions = [
      {
        id: 1,
        question: "‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏¢‡∏•‡πå ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô 4 ‡πÄ‡∏ó‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÇ‡∏î‡∏¢‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÉ‡∏î?",
        choices: ["‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 4 ‡πÄ‡∏ó‡πà‡∏≤", "‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô 1/4 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 2 ‡πÄ‡∏ó‡πà‡∏≤"],
        correct: 2,
        explanation: "P‚ÇÅV‚ÇÅ = P‚ÇÇV‚ÇÇ ‚Üí 4P √ó V‚ÇÇ = P √ó V ‚Üí V‚ÇÇ = V/4"
      },
      {
        id: 2,
        question: "‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡πÅ‡∏Å‡πä‡∏™‡∏£‡∏ß‡∏° ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î n ‡πÅ‡∏•‡∏∞ V ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 300 K ‡πÄ‡∏õ‡πá‡∏ô 600 K ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÉ‡∏î?",
        choices: ["‡∏•‡∏î‡∏•‡∏á 1/2 ‡πÄ‡∏ó‡πà‡∏≤", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 2 ‡πÄ‡∏ó‡πà‡∏≤", "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 4 ‡πÄ‡∏ó‡πà‡∏≤"],
        correct: 1,
        explanation: "P‚ÇÅ/T‚ÇÅ = P‚ÇÇ/T‚ÇÇ ‚Üí P‚ÇÇ = P‚ÇÅ √ó (T‚ÇÇ/T‚ÇÅ) = P‚ÇÅ √ó (600/300) = 2P‚ÇÅ"
      },
      {
        id: 3,
        question: "‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏´‡πâ‡∏á (CO‚ÇÇ Solid) ‡∏ó‡∏µ‡πà 1 atm ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏î‡∏±‡∏ô‡πÑ‡∏≠‡∏Ç‡∏≠‡∏á CO‚ÇÇ ‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?",
        choices: ["‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô‡∏ï‡∏£‡∏á", "‡πÅ‡∏õ‡∏£‡∏ú‡∏Å‡∏ú‡∏±‡∏ô", "‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå"],
        correct: 0,
        explanation: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏î‡∏±‡∏ô‡πÑ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ‡∏ï‡∏≤‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£ Clausius-Clapeyron"
      },
      {
        id: 4,
        question: "‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á‡πÇ‡∏Ñ‡πÄ‡∏ß‡πÄ‡∏•‡∏ô‡∏ï‡πå‡∏£‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏Ç‡πà‡∏≤‡∏¢ (Network Covalent) ‡πÄ‡∏ä‡πà‡∏ô SiO‚ÇÇ ‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏î?",
        choices: ["‡∏ô‡∏≥‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÉ‡∏ô‡∏ô‡πâ‡∏≥", "‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏≠‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏™‡∏π‡∏á", "‡∏ô‡∏≥‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏≠‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ï‡πà‡∏≥", "‡∏ô‡∏≥‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ"],
        correct: 1,
        explanation: "‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á‡πÇ‡∏Ñ‡πÄ‡∏ß‡πÄ‡∏•‡∏ô‡∏ï‡πå‡∏£‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏µ‡∏û‡∏±‡∏ô‡∏ò‡∏∞‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏¢‡∏≤‡∏Å"
      },
      {
        id: 5,
        question: "‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏´‡∏ô‡∏∂‡πà‡∏á ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡∏ú‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥ (72 dyn/cm) ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏≠‡∏ó‡∏≤‡∏ô‡∏≠‡∏• (22 dyn/cm) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏î?",
        choices: ["‡πÄ‡∏≠‡∏ó‡∏≤‡∏ô‡∏≠‡∏•‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤", "‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏û‡∏±‡∏ô‡∏ò‡∏∞‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÄ‡∏à‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á", "‡πÄ‡∏≠‡∏ó‡∏≤‡∏ô‡∏≠‡∏•‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤", "‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤"],
        correct: 1,
        explanation: "‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏û‡∏±‡∏ô‡∏ò‡∏∞‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÄ‡∏à‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏• ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡∏ú‡∏¥‡∏ß‡∏™‡∏π‡∏á"
      },
      {
        id: 6,
        question: "‡πÉ‡∏ô‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πä‡∏™‡∏≠‡∏∏‡∏î‡∏°‡∏Ñ‡∏ï‡∏¥ PV = nRT ‡∏Ñ‡πà‡∏≤ R ‡∏°‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£?",
        choices: ["J/(mol¬∑K)", "atm¬∑L/(mol¬∑K)", "‡∏ó‡∏±‡πâ‡∏á 1 ‡πÅ‡∏•‡∏∞ 2 ‡∏ñ‡∏π‡∏Å", "Pa¬∑m¬≥/(mol¬∑K)"],
        correct: 2,
        explanation: "R ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á P, V, n, T"
      },
      {
        id: 7,
        question: "‡∏à‡∏≤‡∏Å‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏¢‡πå-‡∏•‡∏∏‡∏™‡πÅ‡∏ã‡∏Å ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ 100¬∞C ‡πÄ‡∏õ‡πá‡∏ô 200¬∞C ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏µ‡πà‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå?",
        choices: ["100%", "26.7%", "50%", "200%"],
        correct: 1,
        explanation: "P‚ÇÅ/T‚ÇÅ = P‚ÇÇ/T‚ÇÇ ‚Üí P‚ÇÇ = P‚ÇÅ √ó (473/373) ‚âà 1.267P‚ÇÅ (26.7% ‡πÄ‡∏û‡∏¥‡πà‡∏°)"
      },
      {
        id: 8,
        question: "‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß A ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î (Viscosity) ‡∏™‡∏π‡∏á B ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î‡∏ï‡πà‡∏≥ ‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?",
        choices: ["A ‡πÑ‡∏´‡∏•‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ B", "B ‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤ A", "A ‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á", "A ‡πÅ‡∏•‡∏∞ B ‡πÑ‡∏´‡∏•‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô"],
        correct: 2,
        explanation: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î‡∏™‡∏π‡∏á = ‡πÅ‡∏£‡∏á‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏´‡∏•‡∏ä‡πâ‡∏≤"
      },
      {
        id: 9,
        question: "‡∏ó‡∏µ‡πà 0¬∞C ‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô 1.00 g/cm¬≥ ‡∏ó‡∏µ‡πà 4¬∞C ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô 1.00 g/cm¬≥ ‡∏ó‡∏µ‡πà 20¬∞C ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô 0.998 g/cm¬≥ ‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏î‡∏µ?",
        choices: ["‡∏û‡∏±‡∏ô‡∏ò‡∏∞‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÄ‡∏à‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß", "‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥", "‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏°‡∏µ‡πÇ‡∏û‡∏£‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô"],
        correct: 2,
        explanation: "‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏°‡∏µ‡πÇ‡∏û‡∏£‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡∏∞‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÄ‡∏à‡∏ô ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡πâ‡∏≥"
      },
      {
        id: 10,
        question: "‡∏´‡∏≤‡∏Å‡∏â‡∏µ‡∏î‡πÑ‡∏≠‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô 1 atm ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏≠‡∏ô‡πâ‡∏≥‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏•‡∏î‡∏•‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÉ‡∏î?",
        choices: ["50¬∞C", "75¬∞C", "100¬∞C", "150¬∞C"],
        correct: 2,
        explanation: "‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô 1 atm ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏Ñ‡∏∑‡∏≠ 100¬∞C ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏≠‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß"
      }
    ];

    let activeQuestions = [...initialQuestions];

    const GEMINI_API_KEY = "";

    async function generateQuestionsWithAI() {
      gameState.isAiLoading = true;
      renderStartScreen();

      const prompt = `
        Generate 10 multiple choice questions about Chemistry specifically for Grade 10 (Matthayom 4) curriculum in Thailand.
        Focus ONLY on these topics: States of Matter (Solids, Liquids, Gases), Gas Laws (Boyle, Charles, Avogadro, Ideal Gas), and Properties of Matter.
        Language: Thai.
        Return ONLY a raw JSON array. Do not use Markdown code blocks.
        Format: 
        [
          {
            "id": 1, 
            "question": "Question text in Thai", 
            "choices": ["Option A", "Option B", "Option C", "Option D"], 
            "correct": 0, 
            "explanation": "Brief explanation in Thai"
          }, 
          ...
        ]
      `;

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        });

        const data = await response.json();
        let text = data.candidates[0].content.parts[0].text;
        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
        const newQuestions = JSON.parse(text);
        
        if (Array.isArray(newQuestions) && newQuestions.length > 0 && newQuestions[0].choices) {
          activeQuestions = newQuestions.slice(0, 10);
          alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ‡∏ù‡∏π‡∏á‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß üß¨");
        } else {
          throw new Error("Invalid format");
        }
      } catch (error) {
        console.error("AI Generation failed:", error);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡πÉ‡∏ä‡πâ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ üòÖ");
      } finally {
        gameState.isAiLoading = false;
        renderStartScreen();
      }
    }

    async function getAIHint(question, choices) {
      const hintBtn = document.getElementById('ai-hint-btn');
      const hintTextEl = document.getElementById('ai-hint-text');
      
      if(hintBtn) {
        hintBtn.disabled = true;
        hintBtn.innerHTML = `<div class="loader inline-block w-4 h-4 border-2 border-white/50 border-t-white mr-2"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...`;
      }

      const prompt = `
        Here is a chemistry question: "${question}". 
        Choices: ${JSON.stringify(choices)}. 
        Give a short, helpful hint in Thai that guides the user closer to the correct answer without telling them the answer explicitly. 
        Keep it under 2 sentences. Fun tone.
      `;

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        });

        const data = await response.json();
        const hint = data.candidates[0].content.parts[0].text;
        
        gameState.aiHintText = hint;
        gameState.score -= 2;
        updateScoreUI();
        showScorePopup(-2, window.innerWidth / 2, window.innerHeight / 2);
        
        if(hintTextEl) {
           hintTextEl.innerHTML = `<span class="text-yellow-300 font-bold">üí° ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ AI:</span> ${hint}`;
           hintTextEl.classList.remove('hidden');
           hintTextEl.classList.add('shake');
        }
        
        if(hintBtn) {
            hintBtn.classList.add('hidden');
        }

      } catch (error) {
        console.error("Hint generation failed", error);
        if(hintBtn) hintBtn.innerText = "AI ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á üòÖ";
      }
    }

    function showScorePopup(amount, x, y) {
        const popup = document.createElement('div');
        popup.className = 'score-popup';
        popup.style.color = amount > 0 ? '#4ade80' : '#ff4444';
        popup.innerText = amount > 0 ? `+${amount}` : amount;
        
        // Randomize slight position offset for better effect
        const randomX = (Math.random() - 0.5) * 40;
        
        popup.style.left = (x + randomX) + 'px';
        popup.style.top = y + 'px';
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 1500);
    }

    // --- Graphics ---
    function createGunSVG() {
      return `
        <svg viewBox="0 0 150 100" class="w-full h-full">
          <defs>
            <linearGradient id="gunMetal" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#000;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#333;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#000;stop-opacity:1" />
            </linearGradient>
          </defs>
          <rect x="10" y="40" width="80" height="25" fill="url(#gunMetal)" rx="3"/>
          <rect x="85" y="45" width="55" height="15" fill="#000" rx="2"/>
          <!-- Barrel glow -->
          <circle cx="135" cy="52" r="7" fill="#222"/>
          <circle cx="135" cy="52" r="3" fill="#000"/>
          
          <!-- Scope -->
          <rect x="30" y="25" width="60" height="12" fill="#111" rx="2"/>
          <line x1="35" y1="28" x2="85" y2="28" stroke="#4ade80" stroke-width="1" opacity="0.5"/>
          
          <!-- Detail -->
          <rect x="57" y="65" width="10" height="20" fill="#111" rx="2"/>
          <circle cx="25" cy="30" r="4" fill="#ff0000" opacity="0.8" class="animate-pulse"/>
        </svg>
      `;
    }

    function createZombieSVG(id, isDead = false) {
      // ‡∏™‡∏µ‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡∏®‡∏û‡πÜ
      const colors = ['#4a5a4a', '#3e4a3e', '#556055', '#2f3a2f', '#404040'];
      const zombieColor = colors[id % colors.length];
      const eyeColor = '#ff0000'; 
      
      if (isDead) {
        return `
          <svg viewBox="0 0 100 140" class="w-full h-full">
            <ellipse cx="50" cy="130" r="35" fill="#000" opacity="0.6"/>
            <text x="50" y="80" text-anchor="middle" font-size="60" fill="#555" class="game-font">RIP</text>
          </svg>
        `;
      }
      
      return `
        <svg viewBox="0 0 100 140" class="w-full h-full zombie-idle hover:zombie-hover overflow-visible">
           <defs>
            <filter id="glow-${id}">
              <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <!-- Shadow -->
          <ellipse cx="50" cy="135" rx="30" ry="8" fill="#000" opacity="0.7"/>
          
          <!-- Legs -->
          <path d="M35 100 L30 135" stroke="#1a1a1a" stroke-width="10" stroke-linecap="round"/>
          <path d="M65 100 L70 135" stroke="#1a1a1a" stroke-width="10" stroke-linecap="round"/>
          
          <!-- Tattered Pants -->
          <path d="M35 80 L30 105" stroke="#2a2a2a" stroke-width="11" stroke-linecap="round"/>
          <path d="M65 80 L70 105" stroke="#2a2a2a" stroke-width="11" stroke-linecap="round"/>

          <!-- Body -->
          <path d="M30 40 Q20 80 35 100 L65 100 Q80 80 70 40 Z" fill="${zombieColor}" stroke="#000" stroke-width="1"/>
          
          <!-- Ribs/Gore -->
          <path d="M40 60 L60 60" stroke="#3a1a1a" stroke-width="2" opacity="0.6"/>
          <path d="M42 65 L58 65" stroke="#3a1a1a" stroke-width="2" opacity="0.6"/>
          
          <!-- Ripped Shirt -->
          <path d="M30 45 L35 70" stroke="#333" stroke-width="2"/>
          <path d="M70 45 L65 70" stroke="#333" stroke-width="2"/>

          <!-- Arms (Reaching) -->
          <g class="zombie-arm" style="transform-origin: 25px 45px">
             <path d="M25 45 L10 70" stroke="${zombieColor}" stroke-width="9" stroke-linecap="round"/>
             <path d="M10 70 L5 85" stroke="${zombieColor}" stroke-width="7" stroke-linecap="round"/>
             <!-- Claws -->
             <path d="M5 85 L0 90" stroke="#111" stroke-width="2"/>
             <path d="M5 85 L5 92" stroke="#111" stroke-width="2"/>
          </g>
           <g class="zombie-arm" style="transform-origin: 75px 45px; animation-delay: -0.7s">
             <path d="M75 45 L90 70" stroke="${zombieColor}" stroke-width="9" stroke-linecap="round"/>
             <path d="M90 70 L95 85" stroke="${zombieColor}" stroke-width="7" stroke-linecap="round"/>
             <!-- Claws -->
             <path d="M95 85 L100 90" stroke="#111" stroke-width="2"/>
             <path d="M95 85 L95 92" stroke="#111" stroke-width="2"/>
          </g>
          
          <!-- Head -->
          <circle cx="50" cy="30" r="22" fill="${zombieColor}"/>
          
          <!-- Hair (Messy) -->
          <path d="M30 20 Q40 5 50 8 Q60 5 70 20" fill="none" stroke="#111" stroke-width="4"/>
          
          <!-- Glowing Red Eyes -->
          <circle cx="42" cy="28" r="5" fill="#000"/>
          <circle cx="58" cy="28" r="5" fill="#000"/>
          <circle cx="42" cy="28" r="2.5" fill="${eyeColor}" filter="url(#glow-${id})">
             <animate attributeName="opacity" values="0.5;1;0.5" dur="0.5s" repeatCount="indefinite" />
          </circle>
          <circle cx="58" cy="28" r="2.5" fill="${eyeColor}" filter="url(#glow-${id})">
             <animate attributeName="opacity" values="0.5;1;0.5" dur="0.5s" repeatCount="indefinite" />
          </circle>
          
          <!-- Mouth (Scary) -->
          <path d="M40 40 Q50 50 60 40" fill="#3a1a1a" stroke="none"/>
          <path d="M40 40 L42 45 L45 40 L48 45 L52 40 L55 45 L58 40" fill="none" stroke="#fff" stroke-width="1.5"/>
          
          <!-- Blood Drip -->
          <path d="M45 45 L45 52" stroke="#8b0000" stroke-width="2"/>
          
          <!-- Number Badge -->
          <g transform="translate(50, 10)">
            <circle r="9" fill="#000" stroke="#red" stroke-width="1"/>
            <text y="4" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">${id}</text>
          </g>
        </svg>
      `;
    }

    function createCrosshair() {
      return `
        <svg viewBox="0 0 100 100" class="w-full h-full crosshair-pulse">
          <circle cx="50" cy="50" r="40" fill="none" stroke="#ff0000" stroke-width="1.5" opacity="0.6"/>
          <circle cx="50" cy="50" r="20" fill="none" stroke="#ff0000" stroke-width="1" opacity="0.4"/>
          <circle cx="50" cy="50" r="2" fill="#ff0000"/>
          <line x1="50" y1="5" x2="50" y2="25" stroke="#ff0000" stroke-width="2"/>
          <line x1="50" y1="75" x2="50" y2="95" stroke="#ff0000" stroke-width="2"/>
          <line x1="5" y1="50" x2="25" y2="50" stroke="#ff0000" stroke-width="2"/>
          <line x1="75" y1="50" x2="95" y2="50" stroke="#ff0000" stroke-width="2"/>
        </svg>
      `;
    }

    function renderStartScreen() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 night-bg relative overflow-hidden">
          <div class="absolute top-8 right-8 w-24 h-24 rounded-full bg-yellow-100 opacity-40 shadow-2xl shadow-yellow-200/30"></div>
          <div class="absolute inset-0 pointer-events-none">
            ${Array.from({length: 15}, () => `<div class="absolute w-1 h-1 rounded-full bg-white opacity-60" style="left: ${Math.random()*100}%; top: ${Math.random()*60}%;"></div>`).join('')}
          </div>
          <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-green-900/20 to-transparent pointer-events-none fog-float"></div>
          
          <div class="relative z-10 text-center">
            <h1 id="game-title" class="game-font text-5xl md:text-7xl mb-4 drop-shadow-lg" style="color: ${config.text_color}; text-shadow: 0 0 40px ${config.text_color}80;">
              ${config.game_title}
            </h1>
            <p class="text-xl md:text-2xl mb-2 text-gray-300">‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ ‡∏°.4 - ‡∏ù‡πà‡∏≤‡∏î‡∏á‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ üßü‚Äç‚ôÇÔ∏è</p>
            <p class="text-lg mb-8 text-gray-400">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤ ${config.time_limit} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏ù‡∏π‡∏á‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ 10 ‡∏ï‡∏±‡∏ß!</p>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
              <button id="start-btn" onclick="startGame()" 
                class="px-8 py-4 text-2xl font-bold rounded-xl shadow-2xl transform hover:scale-110 transition-all duration-300 relative overflow-hidden group min-w-[250px]"
                style="background: linear-gradient(135deg, ${config.primary_action}, ${config.primary_action}cc); color: #1a1a2e;"
                ${gameState.isAiLoading ? 'disabled' : ''}>
                <span class="relative z-10 flex items-center gap-2 justify-center">
                  ${config.start_button_text} <span class="text-2xl">üî´</span>
                </span>
              </button>
              
              <button onclick="generateQuestionsWithAI()"
                class="px-8 py-4 text-xl font-bold rounded-xl shadow-2xl transform hover:scale-110 transition-all duration-300 relative overflow-hidden group min-w-[250px]"
                style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;"
                ${gameState.isAiLoading ? 'disabled' : ''}>
                <span class="relative z-10 flex items-center gap-2 justify-center">
                  ${gameState.isAiLoading ? '<div class="loader"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...' : 'üß™ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà AI'}
                </span>
              </button>
            </div>
            
             <div class="mt-8 p-6 rounded-lg max-w-md mx-auto" style="background: ${config.surface_color}dd; border-left: 4px solid ${config.secondary_action};">
              <h3 class="font-bold mb-4 text-lg" style="color: ${config.secondary_action};">üìã ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h3>
              <ul class="text-left text-gray-300 space-y-2">
                <li>üéØ ‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ‡∏¢‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Å‡πä‡∏á <strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ!</strong></li>
                <li>üî´ ‡∏¢‡∏¥‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÑ‡∏Å‡∏• ‡∏¢‡∏¥‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô</li>
                <li>‚úÖ ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å = <span class="text-green-400 font-bold">+5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span> (‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ‡∏ï‡∏≤‡∏¢)</li>
                <li>‚ùå ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î = <span class="text-red-400 font-bold">-2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà)</li>
                <li>üèÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ 30 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    function startGame() {
      // Generate positions for the "Gang"
      // We want them distributed across the screen but not overlapping too much
      const shuffledZombies = [...activeQuestions].sort(() => Math.random() - 0.5);
      
      const positionedZombies = shuffledZombies.map((z, i) => {
        // Distribute in a grid-like fashion or random scatter
        // Rows: Back (0-3), Middle (4-6), Front (7-9)
        let row, xPos, yPos, scale;
        
        if (i < 4) { // Back Row
           row = 'back';
           yPos = 30 + Math.random() * 10; // 30-40% from bottom
           xPos = 10 + (i * 25) + (Math.random() * 10 - 5);
           scale = 0.6 + Math.random() * 0.1;
        } else if (i < 8) { // Middle Row
           row = 'mid';
           yPos = 15 + Math.random() * 10; // 15-25% from bottom
           xPos = 15 + ((i-4) * 22) + (Math.random() * 10 - 5);
           scale = 0.8 + Math.random() * 0.1;
        } else { // Front Row (Scary close!)
           row = 'front';
           yPos = 0 + Math.random() * 5; // 0-5% from bottom
           xPos = 30 + ((i-8) * 30) + (Math.random() * 10 - 5);
           scale = 1.0 + Math.random() * 0.1;
        }

        return {
           ...z,
           display: {
             x: xPos,
             y: yPos,
             scale: scale,
             zIndex: Math.floor(100 - yPos) // Lower Y = Higher Z (closer to camera)
           }
        };
      });

      // Sort by Z-index so closer ones render on top
      positionedZombies.sort((a, b) => a.display.zIndex - b.display.zIndex);

      gameState = {
        currentScreen: 'game',
        zombiesKilled: 0,
        score: 0,
        currentQuestion: null,
        zombies: positionedZombies,
        answeredZombies: new Set(),
        timeLeft: parseInt(config.time_limit),
        timerActive: false,
        mouseX: 0,
        mouseY: 0,
        timerInterval: null,
        isAiLoading: false,
        aiHintText: ""
      };
      renderGameScreen();
    }

    function backToStart() {
      if(gameState.timerInterval) clearInterval(gameState.timerInterval);
      gameState.timerActive = false;
      const modal = document.getElementById('question-modal');
      if (modal) modal.classList.add('hidden');
      renderStartScreen();
    }

    function renderGameScreen() {
      const app = document.getElementById('app');
      
      let zombiesHTML = '';
      
      gameState.zombies.forEach((zombieData, index) => {
        // If dead, don't show or show grave? Let's just remove them for cleaner "shooting gallery" feel
        // or show a fading spirit
        if (gameState.answeredZombies.has(index)) return;

        const { x, y, scale, zIndex } = zombieData.display;
        
        const style = `
          position: absolute;
          bottom: ${y}%;
          left: ${x}%;
          transform: translateX(-50%) scale(${scale});
          z-index: ${zIndex};
          cursor: crosshair;
          transition: transform 0.2s ease;
        `;

        // The actual click handler passes the index in the current gameState.zombies array
        zombiesHTML += `
          <div class="zombie-slot group" style="${style}" onclick="selectZombie(${index}, event)">
            <div class="w-48 h-64 relative transition-transform duration-200 group-hover:scale-110">
               ${createZombieSVG(index + 1)}
               <div class="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-red-900/80 text-red-100 px-2 py-1 rounded border border-red-500 text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                 ‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ #${index + 1} (‡πÄ‡∏•‡πá‡∏á!)
               </div>
            </div>
          </div>
        `;
      });

      app.innerHTML = `
        <div class="h-full w-full flex flex-col night-bg relative overflow-hidden" onmousemove="updateCrosshair(event)">
          <!-- Crosshair -->
          <div id="crosshair" class="fixed w-20 h-20 pointer-events-none gunsight-aim z-[10000]" style="left: 0; top: 0; transform: translate(-40px, -40px);">
             ${createCrosshair()}
          </div>

          <!-- Header -->
          <div class="absolute top-0 left-0 w-full z-[100] p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
             <button onclick="backToStart()" class="px-3 py-1 rounded-lg bg-gray-800 text-white text-sm border border-gray-600 hover:bg-gray-700">üè† ‡∏≠‡∏≠‡∏Å</button>
             
             <div class="flex flex-col items-end">
                <div class="text-4xl font-bold game-font text-green-400 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">
                  SCORE: <span id="header-score">${gameState.score}</span>
                </div>
                <div class="text-sm text-gray-300 flex items-center gap-2">
                   <span>üíÄ KILLS:</span>
                   <div class="flex gap-1">
                      ${Array.from({length: 10}, (_, i) => `
                        <div class="w-3 h-3 rounded-full ${i < gameState.zombiesKilled ? 'bg-green-500 shadow-[0_0_5px_#4ade80]' : 'bg-gray-700'}"></div>
                      `).join('')}
                   </div>
                </div>
             </div>
          </div>

          <!-- Scene Area -->
          <div class="scene-container w-full h-full">
             <div class="ground"></div>
             <!-- Fog -->
             <div class="absolute bottom-0 w-full h-2/3 bg-gradient-to-t from-purple-900/30 to-transparent pointer-events-none z-10 fog-float"></div>
             
             <!-- Zombies Container -->
             <div id="zombie-field" class="w-full h-full relative z-20">
                ${zombiesHTML}
             </div>
          </div>

          <!-- Question Modal -->
          <div id="question-modal" class="fixed inset-0 flex items-center justify-center p-4 z-[9999] hidden">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
            <div id="question-content" class="relative z-10 w-full max-w-2xl bg-gray-900/95 rounded-xl p-6 border-4 border-red-900 shadow-[0_0_50px_rgba(255,0,0,0.2)]">
            </div>
          </div>
        </div>
      `;
      
      document.addEventListener('mousemove', updateCrosshair);
    }

    function updateCrosshair(event) {
      const crosshair = document.getElementById('crosshair');
      if (crosshair) {
        crosshair.style.left = event.clientX + 'px';
        crosshair.style.top = event.clientY + 'px';
      }
    }

    // Triggered when clicking ANY zombie
    function selectZombie(index, event) {
      if (gameState.answeredZombies.has(index)) return;

      gameState.currentQuestion = index;
      gameState.timeLeft = parseInt(config.time_limit);
      gameState.timerActive = true;
      gameState.aiHintText = "";
      
      const question = gameState.zombies[index];
      
      const modal = document.getElementById('question-modal');
      const content = document.getElementById('question-content');
      
      const safeQuestion = question.question.replace(/"/g, '&quot;');
      const safeChoices = JSON.stringify(question.choices).replace(/"/g, '&quot;');

      content.innerHTML = `
        <div class="flex justify-between items-start mb-4 border-b border-gray-700 pb-2">
          <div class="flex items-center gap-3">
             <div class="w-16 h-20 bg-gray-800 rounded flex items-center justify-center overflow-hidden border border-gray-600">
               ${createZombieSVG(index + 1)}
            </div>
            <div>
               <div class="text-red-500 font-bold game-font text-2xl tracking-wider">TARGET LOCKED</div>
               <div class="text-xs text-gray-400">Enemy Unit #${index + 1}</div>
            </div>
          </div>
          <div class="text-right">
             <div id="timer" class="text-5xl font-bold game-font text-red-500 animate-pulse">‚è±Ô∏è ${gameState.timeLeft}</div>
             <button id="ai-hint-btn" onclick="getAIHint('${safeQuestion}', ${safeChoices})" class="text-xs text-purple-300 hover:text-purple-100 underline mt-1">
               üí° ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ AI (-2 ‡πÅ‡∏ï‡πâ‡∏°)
             </button>
          </div>
        </div>

        <div id="ai-hint-text" class="mb-4 bg-purple-900/50 p-3 rounded-lg border border-purple-500/50 text-purple-200 text-sm hidden animate-pulse"></div>
        <div id="feedback-area" class="h-8 mb-2 text-center font-bold text-xl"></div>
        
        <div class="text-lg md:text-xl text-white mb-6 font-serif leading-relaxed p-4 bg-black/40 rounded border-l-4 border-red-600">
          ${question.question}
        </div>
        
        <div class="grid grid-cols-1 gap-3">
          ${question.choices.map((choice, i) => `
            <button id="choice-${i}" onclick="answerQuestion(${i})" 
              class="choice-btn w-full p-4 rounded bg-gray-800 hover:bg-gray-700 border border-gray-600 hover:border-red-500 text-left text-gray-200 transition-all flex items-center group relative overflow-hidden">
              <span class="w-8 h-8 rounded-full bg-black flex items-center justify-center text-sm font-bold text-gray-400 group-hover:bg-red-600 group-hover:text-white mr-3 border border-gray-600 z-10">
                ${String.fromCharCode(65 + i)}
              </span>
              <span class="z-10 relative">${choice}</span>
              <div class="absolute inset-0 bg-red-900/20 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
            </button>
          `).join('')}
        </div>
      `;
      
      modal.classList.remove('hidden');
      startTimer();
    }

    function startTimer() {
      if (gameState.timerInterval) clearInterval(gameState.timerInterval);
      gameState.timerInterval = setInterval(() => {
        if (!gameState.timerActive) {
          clearInterval(gameState.timerInterval);
          return;
        }
        
        gameState.timeLeft--;
        const timerEl = document.getElementById('timer');
        if (timerEl) {
          timerEl.textContent = `‚è±Ô∏è ${gameState.timeLeft}`;
          if (gameState.timeLeft <= 5) timerEl.classList.add('text-red-600', 'scale-110');
        }
        
        if (gameState.timeLeft <= 0) {
          timePenalty();
        }
      }, 1000);
    }

    function timePenalty() {
      gameState.score -= 2;
      updateScoreUI();
      
      const feedback = document.getElementById('feedback-area');
      if(feedback) {
        feedback.innerHTML = `<span class="text-red-500 font-bold shake inline-block">‚ö†Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î! -2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>`;
      }
      
      const modal = document.getElementById('question-content');
      modal.classList.add('shake');
      setTimeout(() => modal.classList.remove('shake'), 500);
      
      // Show popup in center of modal
      showScorePopup(-2, window.innerWidth/2, window.innerHeight/2);
      
      gameState.timeLeft = 10;
    }
    
    function updateScoreUI() {
       const scoreEl = document.getElementById('header-score');
       if(scoreEl) {
          scoreEl.innerText = gameState.score;
          scoreEl.className = gameState.score < 0 ? 'text-red-500' : 'text-green-400';
       }
    }

    function answerQuestion(choiceIndex) {
      const question = gameState.zombies[gameState.currentQuestion];
      const isCorrect = choiceIndex === question.correct;
      const feedback = document.getElementById('feedback-area');
      
      // Calculate center of screen for popup (since modal covers game)
      const popupX = window.innerWidth / 2;
      const popupY = window.innerHeight / 2;

      if (isCorrect) {
        // Success
        gameState.timerActive = false;
        clearInterval(gameState.timerInterval);
        gameState.score += 5;
        gameState.zombiesKilled++;
        updateScoreUI();
        showScorePopup(5, popupX, popupY);
        
        const content = document.getElementById('question-content');
        content.innerHTML = `
          <div class="text-center py-6">
            <div class="text-6xl mb-4 correct-pulse">üí•üî´</div>
            <h3 class="text-4xl font-bold mb-2 text-green-400 game-font tracking-widest">HEADSHOT!</h3>
             <div class="text-6xl font-bold text-green-500 mb-4 animate-bounce">+5</div>
            <p class="text-gray-400 mb-6 text-sm">${question.explanation}</p>
            <button onclick="closeModalAndRefresh()" class="px-8 py-3 bg-red-600 hover:bg-red-700 text-white rounded font-bold uppercase tracking-widest shadow-lg animate-pulse">
              NEXT TARGET
            </button>
          </div>
        `;
      } else {
        // Fail
        gameState.score -= 2;
        updateScoreUI();
        showScorePopup(-2, popupX, popupY);

        const btn = document.getElementById(`choice-${choiceIndex}`);
        if(btn) {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'bg-red-900/50');
            btn.innerHTML += ' <span class="ml-auto text-red-500 font-bold">WRONG</span>';
        }
        if(feedback) {
           feedback.innerHTML = `<span class="text-red-500 font-bold shake inline-block">‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏õ‡πâ‡∏≤! -2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>`;
        }
      }
    }

    function closeModalAndRefresh() {
      const modal = document.getElementById('question-modal');
      modal.classList.add('hidden');
      
      gameState.answeredZombies.add(gameState.currentQuestion);
      
      // Check win condition
      if (gameState.zombiesKilled >= 10) {
        checkEndGame();
      } else {
        renderGameScreen();
      }
    }

    function checkEndGame() {
      if (gameState.score >= 30) {
        gameWin();
      } else {
        gameLose();
      }
    }

    function gameLose() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 night-bg relative">
          <div class="z-10 text-center max-w-2xl bg-black/90 p-8 rounded border-4 border-red-900 shadow-2xl">
            <div class="text-8xl mb-6 grayscale">üßü</div>
            <h2 class="game-font text-6xl text-red-600 mb-4">MISSION FAILED</h2>
            <p class="text-xl text-gray-300 mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ‡∏£‡∏∏‡∏°‡∏Å‡∏¥‡∏ô! (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${gameState.score})</p>
            <button onclick="startGame()" class="px-8 py-4 bg-white text-black font-bold text-xl rounded hover:bg-gray-300 uppercase">
              RETRY MISSION
            </button>
             <div class="mt-4">
               <button onclick="renderStartScreen()" class="text-gray-500 hover:text-white underline text-sm">Main Menu</button>
            </div>
          </div>
        </div>
      `;
    }

    function gameWin() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 night-bg relative">
          <div class="absolute inset-0 overflow-hidden pointer-events-none">
              ${Array.from({length: 30}, () => `<div class="absolute text-yellow-500 text-2xl animate-bounce" style="left:${Math.random()*100}%; top:${Math.random()*100}%; animation-delay:${Math.random()}s">‚òÖ</div>`).join('')}
           </div>
          <div class="z-10 text-center max-w-2xl bg-black/90 p-8 rounded border-4 border-yellow-500 shadow-[0_0_50px_rgba(234,179,8,0.5)]">
            <div class="text-8xl mb-6">üöÅ</div>
            <h2 class="game-font text-6xl text-yellow-400 mb-2">SURVIVOR</h2>
            <p class="text-2xl text-white mb-6">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${gameState.score}</p>
            <div class="bg-gray-800 p-4 rounded mb-6 text-left">
               <p class="text-gray-400 text-sm">STATUS REPORT:</p>
               <p class="text-green-400 font-mono">>> ZOMBIES ELIMINATED: 10/10</p>
               <p class="text-green-400 font-mono">>> CHEMISTRY KNOWLEDGE: ${gameState.score >= 45 ? 'ELITE' : 'ADVANCED'}</p>
            </div>
            <button onclick="startGame()" class="px-8 py-4 bg-yellow-500 text-black font-bold text-xl rounded hover:bg-yellow-400 uppercase shadow-lg">
              PLAY AGAIN
            </button>
          </div>
        </div>
      `;
    }

    renderStartScreen();
  </script>
 </body>
</html>